<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Suivi multi-√©v√©nements</title>
  <link rel="stylesheet" href="https://assets.bouyguestelecom.fr/TRILOGY/trilogy-styles@4.10.0/default/trilogy.css">
</head>
<body>
  <div class="full-page">
    <div class="card">
      <div class="card-content">
        <p class="title is-level-4">üìÖ Suivi de tes √©v√©nements</p>

        <div class="field is-grouped is-grouped-multiline">
          <input id="eventName" type="text" class="input" placeholder="Nom de l‚Äô√©v√©nement" />
          <input id="eventDate" type="datetime-local" class="input" />
          <div class="select">
            <select id="eventVisibility">
              <option value="public">üåç Tout le monde</option>
              <option value="private">üîí Moi uniquement</option>
            </select>
          </div>
          <button id="addEventBtn" class="button is-primary">Ajouter</button>
        </div>

        <div class="field" style="margin-top: 20px;">
          <input id="searchInput" type="text" class="input" placeholder="üîç Rechercher un √©v√©nement‚Ä¶" />
        </div>

        <div id="eventList" style="margin-top: 30px;"></div>
      </div>
    </div>
  </div>

  <script>
    const BIN_ID = '68efad29d0ea881f40a4987f';
    const API_KEY = '$2a$10$jj5y/8wkKDtKzK8xN4ITEuT27TAx4/iKc5qYHz1Kx.eEnYFGdZqBi';
    const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    const eventNameInput = document.getElementById('eventName');
    const eventDateInput = document.getElementById('eventDate');
    const eventVisibilityInput = document.getElementById('eventVisibility');
    const addEventBtn = document.getElementById('addEventBtn');
    const searchInput = document.getElementById('searchInput');
    const eventList = document.getElementById('eventList');

    const currentUser = localStorage.getItem('userId') || crypto.randomUUID();
    localStorage.setItem('userId', currentUser);

    let events = [];

    async function fetchEvents() {
      try {
        const res = await fetch(BASE_URL, {
          headers: { 'X-Access-Key': API_KEY }
        });
        const data = await res.json();
        events = data.record.events || [];
      } catch (err) {
        console.error('Erreur de chargement :', err);
        events = [];
      }
    }

    async function saveEvents() {
      try {
        await fetch(BASE_URL, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Access-Key': API_KEY
          },
          body: JSON.stringify({ events })
        });
      } catch (err) {
        console.error('Erreur de sauvegarde :', err);
      }
    }

    function formatTime(ms) {
      if (ms <= 0) return '00:00:00';
      const s = Math.floor(ms / 1000);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    function renderEvents() {
      eventList.innerHTML = '';
      const now = new Date();
      const query = searchInput.value.trim().toLowerCase();

      events.forEach((ev, index) => {
        if (ev.visibility === 'private' && ev.owner !== currentUser) return;
        if (query && !ev.name.toLowerCase().includes(query)) return;

        const end = new Date(ev.date);
        const start = new Date(ev.created);
        const total = end - start;
        const remaining = end - now;
        const elapsed = now - start;

        let rawPct = (elapsed / total) * 100;
        let pct = rawPct <= 0 ? 0.00001 : Math.min(100, rawPct.toFixed(5));

        const container = document.createElement('div');
        container.className = 'box';
        container.innerHTML = `
          <p class="title is-level-5">${ev.name}</p>
          <p class="text">Temps restant : ${formatTime(remaining)}</p>
          <progress class="progress is-info" value="${pct}" max="100"></progress>
          <p class="text">${pct}% √©coul√©</p>
          <p class="text is-small">Visibilit√© : ${ev.visibility === 'public' ? 'üåç Public' : 'üîí Priv√©'}</p>
          <button class="button is-danger is-small" onclick="deleteEvent(${index})">Supprimer</button>
        `;
        eventList.appendChild(container);
      });
    }

    async function deleteEvent(index) {
      events.splice(index, 1);
      await saveEvents();
      renderEvents();
    }

    addEventBtn.addEventListener('click', async () => {
      const name = eventNameInput.value.trim();
      const date = eventDateInput.value;
      const visibility = eventVisibilityInput.value;
      if (!name || !date) return;

      events.push({
        name,
        date,
        created: new Date().toISOString(),
        visibility,
        owner: currentUser
      });

      await saveEvents();
      renderEvents();
      eventNameInput.value = '';
      eventDateInput.value = '';
    });

    searchInput.addEventListener('input', renderEvents);

    async function init() {
      await fetchEvents();
      renderEvents();
      setInterval(renderEvents, 1000);
    }

    init();
  </script>
</body>
</html>
